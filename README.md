# autoCropRasterLayer
**QGIS** example project showing automatic cropping of raster background layers

![cropRasterLayer](https://github.com/user-attachments/assets/af45d270-8839-4939-b982-e225fc3b12b5)


This **QGIS** example project impressively demonstrates how we can automatically crop a raster background to the respective Atlas feature 
when creating a **QGIS** Atlas using a Python expression function. 
The Python routine uses **GDAL** Warp to write a raster data source to a temporary 
memory **VRT** file. Then copies the generated data source to an existing `cropped_basemap` layer.

This dynamic cropping works thanks to several factors:

1.  **QGIS** allows data sources from raster layers to be specified inline as **GDAL** XML (e.g. **VRT**).
2.  Since **GDAL** version 3.9.0, **GDAL** Warp can process cutlines in **WKT** format (https://github.com/osgeo/gdal/issues/7658).

The **QGIS** example project already contains the necessary Python Expression Functions as **Project Macros** (the execution of macros must be allowed).
The Expression Functions are called in the rendering section of the layout item `Title` (in the `data defined override` of `Exclude items from export`). 
The location of the call is not mandatory here, the Expression Function can also be anchored at any other location.

```python
coalesce(
  cropRasterLayer(
    'basemap_hidpi_5417e2d1_37d1_44f0_aa23_b173e0a630db',
    regexp_replace( eval(@cropped_basemap_ds),'<TileLevel>[^<]+','<TileLevel>'|| @cropped_basemap_tilelevel ),
    geom_to_wkt(@atlas_geometry),
    'EPSG:3857'),
  waitSomeTime(4000),
  0
)
```

The data source for the raster base map to be cropped is specified in the Project Variable `cropped_basemap_ds`.
By default, it refers to the Project Variable `Basemap_hidpi`, which contains an **XML** description of the **GDAL** data source.

The following data sources are available as project variables:
Basemap_hidpi (default)
Basemap_gray
Basemap_ortho
Basemap_OSM

Further **GDAL** XML data source descriptions can be found here: https://github.com/OSGeo/gdal/tree/master/frmts/wms

The maximum tile level can be controlled via the Project Variable `cropped_basemap_tilelevel` (default: 15).

The current Atlas geometry is transferred as **WKT** for the cutline.
The `geom_to_wkt` function also allows us to specify a precision, which unfortunately is not supported in all **QGIS** versions.

To prevent the **VRT** data source generated by **GDAL** Warp from becoming too large, the **GDAL** Config Option `GDALWARP_DENSIFY_CUTLINE` must be set to `NO` (https://trac.osgeo.org/gdal/ticket/6648).

The Python Expression Function `waitSomeTime` is required to give **GDAL** enough time for cropping (default: 4 sec).
Depending on the Computer speed and the Internet connection, the waiting time must be adjusted.
This can be easily recognized by the fact that not all images are cropped during an Atlas Export.

## Credit ##
As always, thanks go to Even Rouault and all the QGIS experts.

![autoCropRasterLayer](https://github.com/user-attachments/assets/414f7176-c179-4801-985f-773e77ee1f34)
